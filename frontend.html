<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOTCORD 3.1</title>
<style>
  body { margin:0; font-family: 'Segoe UI', sans-serif; background:#36393f; color:white; }
  .container { display:flex; height:100vh; }

  /* Sidebar for servers */
  .sidebar { width:200px; background:#2f3136; padding:10px; display:flex; flex-direction:column; }
  .server { padding:10px; margin:5px 0; background:#40444b; border-radius:5px; cursor:pointer; }
  .server:hover { background:#5865f2; }

  /* Chat area */
  .chat-area { flex:1; display:flex; flex-direction:column; }
  .messages { flex:1; overflow-y:auto; padding:15px; }
  
  /* Individual message */
  .message { margin:5px 0; display:flex; align-items:flex-start; }
  .message .pfp { width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover; }
  .message .content { background:#40444b; padding:10px; border-radius:10px; max-width:70%; word-wrap:break-word; }
  .message .username { font-weight:bold; color:#7289da; margin-bottom:2px; display:block; }
  .message .timestamp { font-size:10px; color:#b9bbbe; margin-left:5px; }

  /* Input area */
  .input-area { display:flex; padding:10px; background:#40444b; }
  .input-area input { flex:1; padding:10px; border-radius:5px; border:none; margin-right:5px; }
  .input-area button { padding:10px 15px; border:none; border-radius:5px; background:#5865f2; color:white; cursor:pointer; }

  /* Responsive */
  @media(max-width:600px) {
    .container { flex-direction:column; }
    .sidebar { width:100%; display:flex; flex-direction:row; overflow-x:auto; }
    .server { flex:1; margin:5px; text-align:center; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="sidebar" id="servers">
    <div class="server" onclick="switchServer('general')">#general</div>
    <!-- Add more servers here -->
  </div>

  <div class="chat-area">
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <input id="messageInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
      <input type="file" id="fileInput" style="display:none;" onchange="uploadFile(event)">
      <button onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
    </div>
  </div>
</div>

<script>
let ws;
let username = prompt("Enter your username:");
let currentServer = "general";

function connectWebSocket() {
  ws = new WebSocket(
    location.protocol === "https:" ? "wss://" + location.host + "/ws" : "ws://" + location.host + "/ws"
  );

  ws.onopen = () => {
    ws.send(JSON.stringify({username: username, server: currentServer}));
  };

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    displayMessage(msg);
  };
}

function displayMessage(msg) {
  const messagesDiv = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "message";

  div.innerHTML = `
    <img class="pfp" src="${msg.pfp_path || '/static/pfps/default.png'}">
    <div class="content">
      <span class="username">${msg.username}<span class="timestamp">${msg.timestamp || ''}</span></span>
      ${msg.content}
      ${msg.img_path ? `<br><img src="${msg.img_path}" style="max-width:200px; border-radius:5px; margin-top:5px;">` : ''}
    </div>
  `;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  if(input.value.trim() === "") return;
  ws.send(JSON.stringify({username: username, content: input.value, server: currentServer}));
  input.value = "";
}

document.getElementById("messageInput").addEventListener("keydown", function(e){
  if(e.key === "Enter") sendMessage();
});

function switchServer(server) {
  currentServer = server;
  document.getElementById("messages").innerHTML = '';
  ws.send(JSON.stringify({username: username, server: currentServer}));
}

// Handle image upload
function uploadFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  fetch('/upload_image', {method:'POST', body:formData})
    .then(res => res.json())
    .then(data => {
      ws.send(JSON.stringify({username: username, content: '', server: currentServer, img_path: data.path}));
    })
    .catch(err => console.error(err));
}

connectWebSocket();
</script>

</body>
</html>
